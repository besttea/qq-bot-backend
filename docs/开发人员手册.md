# 开发人员手册 (Developer Guide)

**版本**: 1.0
**日期**: 2026-02-06

---

## 1. 环境搭建

### 1.1 前置要求
*   **Node.js**: v18.0.0+ (LTS)
*   **Docker**: v24.0+ (用于运行 Postgres, Redis)
*   **npm**: v9.0+

### 1.2 快速启动
1.  **克隆项目**
    ```bash
    git clone <repository_url>
    cd QQbot
    ```

2.  **安装依赖**
    ```bash
    npm install
    ```

3.  **启动基础设施**
    ```bash
    docker-compose up -d
    ```
    *   PostgreSQL 端口: `5432`
    *   Redis 端口: `6379`

4.  **初始化数据库**
    ```bash
    npx prisma migrate dev --name init --schema=libs/database/prisma/schema.prisma
    ```

5.  **启动服务**
    ```bash
    # 启动核心业务服务
    npm run start:dev core-service
    
    # 启动 API 网关
    npm run start:dev api-gateway
    
    # 启动 AI Worker
    npm run start:dev ai-worker
    ```

---

## 2. 工程结构 (Monorepo)

本项目基于 NestJS Monorepo 架构：

```text
/
├── apps/
│   ├── api-gateway/      # [入口] 处理 QQ Webhook, 限流, 路由转发
│   ├── core-service/     # [业务] 核心逻辑: Auth, Homework, Grade
│   ├── ai-worker/        # [计算] 消费队列, 调用大模型 API
│   └── web-admin/        # [前端] Next.js 教师管理后台 (待集成)
├── libs/
│   ├── database/         # Prisma Schema & Client, DAO
│   ├── common/           # 共享 DTO, Constants, Utils
│   └── queue/            # BullMQ 生产者/消费者配置
├── docker-compose.yml    # 基础设施编排
└── package.json          # 根依赖管理
```

---

## 3. 开发规范

### 3.1 命名规范
*   **文件名**: kebab-case (e.g., `auth-service.ts`)
*   **类名**: PascalCase (e.g., `AuthService`)
*   **变量/方法**: camelCase (e.g., `findUserById`)
*   **数据库表**: snake_case (e.g., `users`, `submission_records`)

### 3.2 代码提交
*   遵循 **Conventional Commits** 规范：
    *   `feat: add homework creation api`
    *   `fix: resolve login timeout issue`
    *   `docs: update api reference`

### 3.3 数据库变更
*   修改 `libs/database/prisma/schema.prisma`。
*   运行 `npx prisma migrate dev --name <description>` 生成迁移文件。
*   **严禁** 手动修改数据库表结构。

---

## 4. API 参考 (Core Service)

所有接口需携带 `Authorization: Bearer <token>` (登录接口除外)。

### 4.1 认证 (Auth)
*   `POST /auth/qq-login`: QQ 授权登录
    *   Payload: `{ code: "..." }`
    *   Response: `{ accessToken: "...", user: { ... } }`

### 4.2 作业 (Homeworks)
*   `POST /homeworks`: 发布作业
*   `GET /homeworks`: 获取作业列表
*   `GET /homeworks/:id`: 获取详情

### 4.3 提交 (Submissions)
*   `POST /submissions`: 学生提交作业
    *   Payload: `{ homeworkId: "...", content: "..." }`

---

## 5. 调试与测试

### 5.1 单元测试
```bash
npm run test
```

### 5.2 E2E 测试
```bash
npm run test:e2e
```

### 5.3 队列监控
*   推荐安装 `bull-board` 或使用 Redis GUI 查看 `bull:ai-scoring-queue` 键值。
