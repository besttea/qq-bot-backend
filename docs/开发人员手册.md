# å¼€å‘äººå‘˜æ‰‹å†Œ (Developer Guide)

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2026-02-06

---

## 1. ç¯å¢ƒæ­å»º

### 1.1 å‰ç½®è¦æ±‚
*   **Node.js**: v18.0.0+ (LTS)
*   **Docker**: v24.0+ (ç”¨äºè¿è¡Œ Postgres, Redis)
*   **npm**: v9.0+

### 1.2 å¿«é€Ÿå¯åŠ¨
1.  **å…‹éš†é¡¹ç›®**
    ```bash
    git clone <repository_url>
    cd QQbot
    ```

2.  **å®‰è£…ä¾èµ–**
    ```bash
    npm install
    ```

3.  **å¯åŠ¨åŸºç¡€è®¾æ–½**
    ```bash
    docker-compose up -d
    ```
    *   PostgreSQL ç«¯å£: `5432`
    *   Redis ç«¯å£: `6379`

4.34â†’4.  **åˆå§‹åŒ–æ•°æ®åº“**
    ```bash
    # è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒä¼šå°† Prisma Client ç”Ÿæˆåˆ° libs/database/src/generated/client
    npx prisma generate --schema=libs/database/prisma/schema.prisma
    
    # è¿è¡Œæ•°æ®åº“è¿ç§» (æ³¨æ„ï¼šç”±äº Prisma 7 çš„é…ç½®å˜æ›´ï¼Œè¿ç§»å‘½ä»¤ä¼šè‡ªåŠ¨è¯»å– prisma.config.ts)
    npx prisma migrate dev --name init --schema=libs/database/prisma/schema.prisma
    ```

5.  **å¯åŠ¨æœåŠ¡ (Step 1)**
    
    > è¯·æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£ï¼ˆæˆ‘ä»¬ç§°ä¸º **"æœåŠ¡çª—å£"**ï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚æ­¤çª—å£ä¸èƒ½å…³é—­ï¼Œå¦åˆ™æœåŠ¡ä¼šåœæ­¢ã€‚

    **æ¨èæ–¹å¼ï¼šä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡**
    ```bash
    npm run start:all
    ```
    *   **æˆåŠŸæ ‡å¿—**: å½“ä½ çœ‹åˆ°ç±»ä¼¼ `[NestApplication] Nest application successfully started` çš„ç»¿è‰²æ—¥å¿—æ—¶ï¼Œè¯´æ˜æœåŠ¡å¯åŠ¨æˆåŠŸã€‚

6.  **é…ç½®å…¬ç½‘è®¿é—® (Step 2)**
    
    > è¯·æ‰“å¼€å¦ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£ï¼ˆæˆ‘ä»¬ç§°ä¸º **"ç©¿é€çª—å£"**ï¼‰ã€‚ç”±äº QQ æœåŠ¡å™¨åœ¨å…¬ç½‘ä¸Šï¼Œå®ƒæ— æ³•ç›´æ¥è®¿é—®ä½ æœ¬åœ°ç”µè„‘ï¼Œæˆ‘ä»¬éœ€è¦ç”¨è¿™ä¸ªå·¥å…·â€œæ‰“ä¸ªæ´â€ã€‚

    1.  **ä¸‹è½½å·¥å…·**: [ç‚¹å‡»ä¸‹è½½ cloudflared.exe](https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe)ï¼Œå°†å…¶æ”¾åˆ°é¡¹ç›®æ ¹ç›®å½• `C:\VSWork\QQbot\` ä¸‹ã€‚
    2.  **å¯åŠ¨ç©¿é€**:
        ```bash
        # è¿è¡Œæ­¤å‘½ä»¤ï¼Œå°†æœ¬åœ° 3000 ç«¯å£æš´éœ²ç»™å…¨ä¸–ç•Œ
        .\cloudflared.exe tunnel --url http://localhost:3000
        ```
    3.  **è·å–å…¬ç½‘åœ°å€**:
        è§‚å¯Ÿç»ˆç«¯è¾“å‡ºï¼Œæ‰¾åˆ°ç±»ä¼¼ä¸‹æ–¹çš„æ—¥å¿—ï¼š
        ```text
        INF +--------------------------------------------------------------------------------------------+
        INF |  Your quick Tunnel has been created! Visit it at (it may take some time to be reachable):  |
        INF |  https://random-words-name.trycloudflare.com                                             |
        INF +--------------------------------------------------------------------------------------------+
        ```
        ğŸ‘‰ **å¤åˆ¶é‚£ä¸ªä»¥ `https://` å¼€å¤´çš„ç½‘å€**ã€‚

    > **æ³¨æ„**: è¿™ä¸ª **"ç©¿é€çª—å£"** ä¹Ÿä¸èƒ½å…³é—­ï¼æ¯æ¬¡é‡å¯è¿™ä¸ªçª—å£ï¼Œç½‘å€éƒ½ä¼šå˜ï¼Œä½ éœ€è¦é‡æ–°æ‰§è¡Œç¬¬ 7 æ­¥ã€‚

7.  **ç»‘å®š QQ æœºå™¨äºº (Step 3)**

    1.  **ç™»å½•åå°**: è®¿é—® [QQ å¼€æ”¾å¹³å°](https://q.qq.com/)ï¼Œè¿›å…¥ **æœºå™¨äººç®¡ç† -> å¼€å‘è®¾ç½®**ã€‚
    2.  **å¡«å†™å›è°ƒåœ°å€**:
        *   å°†ç¬¬ 6 æ­¥å¤åˆ¶çš„ç½‘å€å¡«å…¥ï¼Œå¹¶åŠ ä¸Š `/webhook` åç¼€ã€‚
        *   ä¾‹å¦‚: `https://random-words-name.trycloudflare.com/webhook`
    3.  **éªŒè¯**: ç‚¹å‡» **"éªŒè¯"** æŒ‰é’®ã€‚
        *   å¦‚æœæç¤º "éªŒè¯æˆåŠŸ"ï¼Œæ­å–œä½ ï¼Œæœºå™¨äººå·²ä¸Šçº¿ï¼
        *   å¦‚æœæç¤º "æ ¡éªŒå¤±è´¥"ï¼Œè¯·æ£€æŸ¥æœåŠ¡çª—å£æ˜¯å¦æœ‰æŠ¥é”™æ—¥å¿—ã€‚

---

## 2. æ¯æ—¥å¼€å‘æµç¨‹ (Daily Workflow)

æ¯å¤©å¼€å§‹å·¥ä½œæ—¶ï¼Œè¯·æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹ä¸‰æ­¥ï¼š

1.  **å¯åŠ¨æœåŠ¡**: æ‰“å¼€ç»ˆç«¯è¿è¡Œ `npm run start:all`ã€‚
2.  **å¯åŠ¨ç©¿é€**: æ‰“å¼€æ–°ç»ˆç«¯è¿è¡Œ `.\cloudflared.exe tunnel --url http://localhost:3000`ã€‚
3.  **æ›´æ–°åœ°å€**: å¤åˆ¶æ–°çš„ `https://...` åœ°å€ï¼Œå» QQ å¼€æ”¾å¹³å°æ›´æ–°å›è°ƒé…ç½®ã€‚

---

## 3. å¸¸è§é—®é¢˜æ’æŸ¥ (Troubleshooting)

### Q: æµè§ˆå™¨è®¿é—® Cloudflare åœ°å€æ˜¾ç¤º Error 1033ï¼Ÿ
*   **åŸå› **: ä½ çš„ `cloudflared.exe` è¿›ç¨‹æ–­å¼€äº†ï¼Œæˆ–è€…ä½ åˆšåˆšé‡å¯äº†å®ƒä½†ç”¨äº†æ—§åœ°å€ã€‚
*   **è§£å†³**: æ£€æŸ¥ "ç©¿é€çª—å£" æ˜¯å¦è¿˜åœ¨è¿è¡Œã€‚å¦‚æœé‡å¯è¿‡ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨æ–°ç”Ÿæˆçš„ URLã€‚

### Q: QQ å¹³å°æç¤º "æ ¡éªŒå¤±è´¥"ï¼Ÿ
*   **åŸå›  1**: åœ°å€å¡«é”™äº†ï¼Œå¿˜äº†åŠ  `/webhook`ã€‚
*   **åŸå›  2**: æœ¬åœ°æœåŠ¡æ²¡å¯åŠ¨ã€‚è¯·æ£€æŸ¥ "æœåŠ¡çª—å£" æ˜¯å¦æœ‰æŠ¥é”™ã€‚
*   **åŸå›  3**: ç­¾åé”™è¯¯ã€‚è¯·æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `QQ_APP_SECRET` æ˜¯å¦æ­£ç¡®ã€‚

---

## 4. å·¥ç¨‹ç»“æ„ (Monorepo)

æœ¬é¡¹ç›®åŸºäº NestJS Monorepo æ¶æ„ï¼š

```text
/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api-gateway/      # [å…¥å£] å¤„ç† QQ Webhook, é™æµ, è·¯ç”±è½¬å‘
â”‚   â”œâ”€â”€ core-service/     # [ä¸šåŠ¡] æ ¸å¿ƒé€»è¾‘: Auth, Homework, Grade
â”‚   â”œâ”€â”€ ai-worker/        # [è®¡ç®—] æ¶ˆè´¹é˜Ÿåˆ—, è°ƒç”¨å¤§æ¨¡å‹ API
â”‚   â””â”€â”€ web-admin/        # [å‰ç«¯] Next.js æ•™å¸ˆç®¡ç†åå° (å¾…é›†æˆ)
â”œâ”€â”€ libs/
â”‚   â”œâ”€â”€ database/         # Prisma Schema & Client, DAO
â”‚   â”œâ”€â”€ common/           # å…±äº« DTO, Constants, Utils
â”‚   â””â”€â”€ queue/            # BullMQ ç”Ÿäº§è€…/æ¶ˆè´¹è€…é…ç½®
â”œâ”€â”€ docker-compose.yml    # åŸºç¡€è®¾æ–½ç¼–æ’
â””â”€â”€ package.json          # æ ¹ä¾èµ–ç®¡ç†
```

---

## 3. å¼€å‘è§„èŒƒ

### 3.1 å‘½åè§„èŒƒ
*   **æ–‡ä»¶å**: kebab-case (e.g., `auth-service.ts`)
*   **ç±»å**: PascalCase (e.g., `AuthService`)
*   **å˜é‡/æ–¹æ³•**: camelCase (e.g., `findUserById`)
*   **æ•°æ®åº“è¡¨**: snake_case (e.g., `users`, `submission_records`)

### 3.2 ä»£ç æäº¤
*   éµå¾ª **Conventional Commits** è§„èŒƒï¼š
    *   `feat: add homework creation api`
    *   `fix: resolve login timeout issue`
    *   `docs: update api reference`

### 3.3 æ•°æ®åº“å˜æ›´
*   ä¿®æ”¹ `libs/database/prisma/schema.prisma`ã€‚
*   è¿è¡Œ `npx prisma migrate dev --name <description>` ç”Ÿæˆè¿ç§»æ–‡ä»¶ã€‚
*   **ä¸¥ç¦** æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„ã€‚

---

## 4. API å‚è€ƒ (Core Service)

æ‰€æœ‰æ¥å£éœ€æºå¸¦ `Authorization: Bearer <token>` (ç™»å½•æ¥å£é™¤å¤–)ã€‚

### 4.1 è®¤è¯ (Auth)
100â†’*   `POST /auth/qq-login`: QQ æˆæƒç™»å½•
101â†’    *   Payload: `{ code: "..." }`
102â†’    *   Response: `{ accessToken: "...", user: { ... } }`
103â†’    *   **Mock æµ‹è¯•**: ä½¿ç”¨ `test_code_teacher` æˆ– `test_code_student` ä½œä¸º `code` å³å¯ç»•è¿‡çœŸå® QQ éªŒè¯ç›´æ¥ç™»å½•ã€‚
104â†’
### 4.2 ä½œä¸š (Homeworks)
*   `POST /homeworks`: å‘å¸ƒä½œä¸š
*   `GET /homeworks`: è·å–ä½œä¸šåˆ—è¡¨
*   `GET /homeworks/:id`: è·å–è¯¦æƒ…

### 4.3 æäº¤ (Submissions)
*   `POST /submissions`: å­¦ç”Ÿæäº¤ä½œä¸š
    *   Payload: `{ homeworkId: "...", content: "..." }`

---

## 5. è°ƒè¯•ä¸æµ‹è¯•

### 5.1 å•å…ƒæµ‹è¯•
```bash
npm run test
```

### 5.2 E2E æµ‹è¯•
```bash
npm run test:e2e
```

### 5.3 é˜Ÿåˆ—ç›‘æ§
*   æ¨èå®‰è£… `bull-board` æˆ–ä½¿ç”¨ Redis GUI æŸ¥çœ‹ `bull:ai-scoring-queue` é”®å€¼ã€‚
